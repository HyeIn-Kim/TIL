# 14장 전역 변수의 문제점

## 14.1 변수의 생명 주기

### 14.1.1 지역 변수의 생명 주기

- 지역 변수의 생명 주기는 함수의 생명 주기와 일치한다.

```javascript
var x = "global";

function foo() {
  console.log(x); // undefined (지역 변수가 선언만 된 상태)
  var x = "local";
  return x;
}

foo();
console.log(x); // 'global'
```

- 함수가 호출되면 (선언이 아니다!) 가장 먼저 함수 내에서 쓰이는 변수들을 호이스팅한 뒤 할당문을 만나면 변수에 값을 할당한다.
- 함수가 종료되면 함수 내 지역 변수들은 소멸된다.
- 함수 내부에서 선언된 지역 변수는 함수가 생성한 스코프에 등록된다. 따라서 변수는 자기가 등록된 스코프가 소멸(메모리 해제)될 때까지 유효하다. 할당된 메모리 공간은 더 이상 그 누구도 참조하지 않을 때 가비지 콜렉터에 의해 해제되어 가용 메모리 풀로 반환된다.
  - 누군가가 메모리 공간을 참조하고 있으면 해제되지 않고 확보된 상태로 남아 있음 -> 클로저
  - **호이스팅은 스코프 단위로 동작한다.**
  - 호이스팅은 변수 선언이 스코프의 선두로 끌어 올려진 것처럼 동작하는 자바스크립트 고유의 특징이다. 그동안 모든 변수가 다 끌어 올려지는 것처럼 보였던 건, 전역 변수들이었기 때문.

### 14.1.2 전역 변수의 생명 주기

- 전역 코드는 코드가 로드되자마자 곧바로 해석되고 실행되며, 반환문을 사용할 수 없으므로 더 이상 실행할 문이 없을 때 종료된다.
- `var` 키워드로 선언한 전역 변수는 전역 객체의 프로퍼티가 된다 = 생명 주기가 전역 객체의 생명 주기와 일치한다.
  - 전역 객체(global object): 코드가 실행되기 이전 단계에 자바스크립트 엔진에 의해 어떤 객체보다도 먼저 생성되는 특수한 객체.
    - 클라이언트 사이드 환경(브라우저): `window`
    - 서버 사이드 환경(Node.js): `global`
    - `window`, `self`, `this`, `frames`, `global` 등 전역 객체를 가리키는 다양한 식별자가 있었으나 ES11에서 `globalThis`로 통일됨
    - 표준 빌트인 객체(`Object`, `String`, `Number`, `Function`, `Array`...)와 환경에 따른 호스트 객체(`Web API(클라이언트)`, `호스트 API(Node.js)`), `var` 키워드로 선언한 전역 변수/함수를 프로퍼티로 가짐

## 14.2 전역 변수의 문제점

- 암묵적 결합(implicit coupling): 모든 코드가 전역 변수를 참조하고 변경할 수 있다. 변수의 유효 범위가 크면 클수록 코드의 가독성은 나빠지고 의도치 않게 상태가 변경될 위험성도 높아진다.
- 긴 생명 주기: 생명 주기가 길어 메모리 리소스를 오랜 기간 소비한다. 전역 변수 이름이 중복되면 의도치 않은 재할당이 일어난다.
- 스코프 체인 상에서 종점에 존재: 스코프 체인은 변수를 참조하는 스코프에서부터 시작한다. 즉, 전역 변수는 항상 스코프 체인의 마지막에 있으므로 검색 속도가 느려진다.
- 네임스페이스 오염: 자바스크립트는 파일이 분리되어 있어도 하나의 전역 스코프를 공유한다. 다른 파일 내에서 동일한 이름으로 명명된 전역 변수/함수가 같은 스코프 내에 존재할 경우……상상만 해도 끔찍하다.

## 14.3 전역 변수의 사용을 억제하는 방법

- 전역 변수는 가급적, 진짜진짜 필요한 경우 외에는 억제하고 지역 변수를 사용하도록 한다. 변수의 스코프는 좁을수록 좋다.
- 다음은 전역 변수의 사용을 억제할 수 있는 방법들이다.

### 14.3.1 즉시 실행 함수

```javascript
(function () {
  var foo = 10;
})();
```

- 모든 코드를 즉시 실행 함수로 감싸면 모든 변수는 즉시 실행 함수의 지역 변수가 된다.
- 전역 변수를 생성하지 않으므로 라이브러리 등에 자주 사용된다.

### 14.3.2 네임스페이스 객체

- 전역에 네임스페이스 역할을 담당할 객체를 생성하고 전역 변수처럼 사용하고 싶은 변수를 프로퍼티로 추가한다.

```javascript
var MYAPP = {};

MYAPP.name = "Lee";

console.log(MYAPP.name); // Lee
```

- 네임스페이스에 객체를 넣어서 계층적으로 구성할 수도 있다.
- 네임스페이스별로 분리는 되지만 네임스페이스가 결국 전역 변수니까……글쎄?

## 14.3.3 모듈 패턴
